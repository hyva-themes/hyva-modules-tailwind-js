#!/usr/bin/env node
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

import fs from "node:fs/promises";
import { existsSync } from "node:fs";
import path from "node:path";
import { cwd, exit } from "node:process";
import {
    consoleError,
    consoleWarn,
    basePath,
    getRelativePath,
    getJsonFile,
} from "../src/utils/index.js";

const currentFolderName = path.basename(cwd());
if (currentFolderName !== "tailwind") {
    consoleError(
        `Hyvä Sources should be run from a "tailwind" directory\nto ensure everthing is generated in the correct location.`
    );
    exit(1);
}

const hyvaThemesJsonInclude = "hyva-themes.json";
const hyvaThemesJsonConfig = "hyva.config.json";
const includeConfig = getJsonFile(`app/etc/${hyvaThemesJsonInclude}`, {
    filePath: basePath,
    errorMessage: `No ${hyvaThemesJsonInclude} found, make sure to create one with 'bin/magento hyva:config:generate'`,
});
const hyvaConfig = getJsonFile(hyvaThemesJsonConfig);
const filteredModules =
    includeConfig.extensions?.filter((module) => {
        const isExcluded = hyvaConfig.tailwind?.exclude?.some(
            (excluded) => excluded.src === module.src
        );
        return !isExcluded;
    }) ?? [];
const includedModules = hyvaConfig.tailwind?.include ?? [];
const hyvaModules = [...filteredModules, ...includedModules];

(async () => {
    try {
        const gitignorePath = path.join(basePath, ".gitignore");
        if (existsSync(gitignorePath)) {
            const gitignore = await fs.readFile(gitignorePath, "utf-8");
            if (gitignore.split("\n").some((line) => line.trim() === "*")) {
                consoleWarn(
                    [
                        "",
                        'Warning: Your root .gitignore file contains a single "*" character, which is an allow-list pattern.',
                        "This pattern is not supported by Tailwind CSS v4 for content scanning.",
                        "Tailwind will not be able to find your template files, resulting in missing CSS.",
                        "Please use a traditional exclude-list in your .gitignore file.",
                        "",
                    ].join("\n")
                );
            }
        }
    } catch (error) {
        // Fail silently.
    }
})();

const { importStatements, sourceStatements, moduleStatements } =
    hyvaModules?.reduce(
        (acc, theme) => {
            if (!theme.src) return acc;

            if (theme.src.startsWith("./") || theme.src.startsWith("../")) {
                consoleWarn(
                    [
                        `Warning: Do not use relative paths (e.g., "./" or "../") in the "src" configuration for ${theme.src}`,
                        '"hyva-sources" automatically resolves all paths from the Magento 2 project root.',
                    ].join("\n")
                );
            }

            const themePath = getRelativePath(theme.src);
            const themeCSSPath = getRelativePath(theme.src, "generated");

            const tailwindCSSPath = path.join(
                themePath,
                "view/frontend/tailwind/module.css"
            );
            const tailwindSourceCSSPath = path.join(
                themePath,
                "view/frontend/tailwind/tailwind-source.css"
            );

            const importPath = (cssPath) =>
                `@import "${themeCSSPath}/view/frontend/tailwind/${cssPath}";\n`;

            if (existsSync(tailwindCSSPath)) {
                acc.moduleStatements += importPath("module.css");
            } else {
                acc.sourceStatements += `@source "${themeCSSPath}/**/*.phtml";\n`;
                acc.sourceStatements += `@source "${themeCSSPath}/**/*.xml";\n`;
                if (existsSync(tailwindSourceCSSPath)) {
                    acc.importStatements += importPath("tailwind-source.css");
                }
            }
            return acc;
        },
        { importStatements: "", sourceStatements: "", moduleStatements: "" }
    ) ?? { importStatements: "", sourceStatements: "", moduleStatements: "" };

const hyvaSourceCSS = `/**
 * This file is automatically generated.
 * Do not edit this file!
 *
 * To prevent modules from being added,
 * please exclude them in your theme using the ${hyvaThemesJsonConfig} configuration.
 */\n\n${sourceStatements}\n${importStatements}\n${moduleStatements}\n`;

(async () => {
    try {
        await fs.mkdir(path.join(cwd(), "generated"), { recursive: true });
        await fs.writeFile(
            path.join(cwd(), "generated/hyva-source.css"),
            hyvaSourceCSS
        );
    } catch (err) {
        consoleError(
            "Failed to generate hyva-source.css:\n" +
                (err && err.stack ? err.stack : err)
        );
        exit(1);
    }
})();
